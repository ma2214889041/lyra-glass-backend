name = "lyra-api"
main = "src/index.ts"
compatibility_date = "2026-01-01"
compatibility_flags = ["nodejs_compat"]

# 自定义域名
routes = [
	{ pattern = "api.glass.lyrai.eu", custom_domain = true }
]

# D1 数据库绑定
[[d1_databases]]
binding = "DB"
database_name = "lyra-db"
database_id = "569b2047-c680-4b6f-9103-49dd6454e92a"

# R2 存储绑定
[[r2_buckets]]
binding = "R2"
bucket_name = "ai-glass"
preview_bucket_name = "ai-glass"

# Session 缓存 KV
[[kv_namespaces]]
binding = "SESSION_KV"
id = "76f4076c901b4c94a3de0eba84c2abcb"


# 环境变量（敏感信息使用 wrangler secret put）
[vars]
ADMIN_USERNAME = "admin"
# 以下通过 wrangler secret put 设置:
# ADMIN_PASSWORD
# GEMINI_API_KEY
# STRIPE_SECRET_KEY
# STRIPE_WEBHOOK_SECRET

# Cloudflare Queues 配置
# 生产者绑定：发送消息到队列
[[queues.producers]]
queue = "generation-queue"
binding = "GENERATION_QUEUE"

# 消费者绑定：处理队列消息
[[queues.consumers]]
queue = "generation-queue"
max_batch_size = 5
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "generation-dlq"

# Durable Objects
[durable_objects]
bindings = [
  { name = "TASK_MONITOR", class_name = "TaskMonitor" }
]

# Migrations
[[migrations]]
tag = "v1"
new_classes = ["TaskMonitor"]

# 定时任务 (Cron Triggers)
[triggers]
crons = ["*/5 * * * *", "0 3 * * *"]  # 每5分钟检查卡住的任务 + 每天凌晨3点清理过期数据

# 开发环境配置
[env.dev]
name = "lyra-api-dev"

[[env.dev.d1_databases]]
binding = "DB"
database_name = "lyra-db-dev"
database_id = "59b1e942-a4ca-49d3-a0d1-9bbdef1b5d5c"

[[env.dev.r2_buckets]]
binding = "R2"
bucket_name = "lyra-storage-dev"

# 开发环境 Queue（可选，本地开发时会回退到直接处理）
# [[env.dev.queues.producers]]
# queue = "generation-queue-dev"
# binding = "GENERATION_QUEUE"
